app-id: net.pcsx2.PCSX2
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: '22.08'
command: pcsx2
rename-desktop-file: PCSX2.desktop
rename-icon: PCSX2

finish-args:
  - --device=all
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio

modules:
  - name: wxWidgets
    buildsystem: cmake-ninja
    cleanup:
      - /bin
      - /include
      - /share/bakefile
      - /share/aclocal
      - /lib/wx/include
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    build-options:
      cxxflags: -std=c++0x
    sources:
      - type: git
        url: https://github.com/wxWidgets/wxWidgets.git
        tag: v3.2.1
        commit: 97e99707c5d2271a70cb686720b48dbf34ced496
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
    modules:
      - ../shared-modules/glu/glu-9.json

  - name: libaio
    cleanup:
      - /include
      - /lib/*.a
    buildsystem: simple
    build-options:
      cflags: -O2 -pipe -fno-stack-protector -fno-plt
    build-commands:
      - make
      - make prefix=/app libdir=/app/lib install
    sources:
      - type: archive
        url: https://pagure.io/libaio/archive/libaio-0.3.113/libaio-libaio-0.3.113.tar.gz
        sha256: 716c7059703247344eb066b54ecbc3ca2134f0103307192e6c2b7dab5f9528ab
        x-checker-data:
          type: anitya
          project-id: 1557
          stable-only: true
          url-template: https://pagure.io/libaio/archive/libaio-$version/libaio-libaio-$version.tar.gz

  - name: portaudio
    cleanup:
      - /include
      - /lib/pkgconfig
      - /lib/*.la
    config-opts:
      - --disable-static
    sources:
      - type: git
        url: https://github.com/PortAudio/portaudio.git
        commit: 147dd722548358763a8b649b3e4b41dfffbcfbb6
        tag: v19.7.0
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
  - name: soundtouch
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://codeberg.org/soundtouch/soundtouch.git
        tag: 2.3.1
        commit: e1f315f5358d9db5cee35a7a2886425489fcefe8
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/aclocal
      - /share/doc
      - /lib/*.la

  - name: libpcap
    cleanup:
      - /include
      - /share
      - /lib/pkgconfig
    sources:
      - type: archive
        url: https://www.tcpdump.org/release/libpcap-1.10.1.tar.gz
        sha256: ed285f4accaf05344f90975757b3dbfe772ba41d1c401c2648b7fa45b711bdd4
        x-checker-data:
          type: anitya
          project-id: 1702
          stable-only: true
          url-template: https://www.tcpdump.org/release/libpcap-$version.tar.gz

  - name: rapidyaml
    buildsystem: cmake-ninja
    cleanup:
      - /include
    sources:
      - type: git
        url: https://github.com/biojppm/rapidyaml.git
        tag: v0.4.1
        commit: 213b201d264139cd1b887790197e08850af628e3
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$

  - name: pcsx2
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      build-args:
        - --share=network
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DXDG_STD=TRUE
      - -DDISABLE_BUILD_DATE=TRUE
      - -DOpenGL_GL_PREFERENCE=GLVND
      - -DPACKAGE_MODE=TRUE
      - -DCMAKE_INSTALL_PREFIX:PATH=/app/
      - -DDISABLE_SETCAP=TRUE
      - -DSDL2_API=TRUE
      - -DWAYLAND_API=ON
      - -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON
      - -DUSE_SYSTEM_YAML=TRUE
    cleanup:
      - /share/pixmaps
      - /share/man
      - /share/doc
    post-install:
      - desktop-file-edit --set-key=Exec --set-value=pcsx2 /app/share/applications/PCSX2.desktop
      - install -Dm644 ../pcsx2/gui/Resources/AppIcon64.png /app/share/icons/hicolor/64x64/apps/PCSX2.png
      - install -Dm644 ../net.pcsx2.PCSX2.appdata.xml /app/share/appdata/net.pcsx2.PCSX2.appdata.xml
    sources:
      - type: git
        url: https://github.com/PCSX2/pcsx2.git
        commit: aa075bdf6b0e1ac9b72271b25e25aa6a4cf88bef
        disable-shallow-clone: true
        disable-submodules: true
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
          is-main-source: true
        tag: v1.7.3325
      - type: file
        path: net.pcsx2.PCSX2.appdata.xml
      - type: shell
        commands:
          - git submodule init
          - git submodule update
